jQuery.fn.flexdatalist=function(b,c){var d=$(document),f=$(this),a,e=this;a=function(){var l=$(this),j,m,k={},i="",g=null,h=l.attr("name");if(l.hasClass("flexdatalist-set")){e._destroy(l)}e._options(l,$.extend({url:null,data:[],params:{},relatives:null,chainedRelatives:false,cache:true,minLength:2,groupBy:false,selectionRequired:false,focusFirstResult:false,textProperty:null,valueProperty:null,visibleProperties:[],searchIn:["label"],searchContain:false,searchEqual:false,searchByWord:false,searchDisabled:false,normalizeString:null,multiple:l.is("[multiple]"),maxShownResults:100,noResultsText:'No results found for "{keyword}"',toggleSelected:false,allowDuplicateValues:false,requestType:"get",limitOfValues:0,_values:[]},l.data(),(typeof b==="object"?b:{})));l._options=function(o,n){return e._options(l,o,n)};j=l.clone(false).attr({list:null,name:null,id:(l.attr("id")?l.attr("id")+"-flexdatalist":null)}).addClass("flexdatalist-alias").removeClass("flexdatalist");if(l._options("multiple")){m=$("<ul>").addClass("flexdatalist-multiple").css({"border-color":l.css("border-left-color"),"border-width":l.css("border-left-width"),"border-style":l.css("border-left-style"),"border-radius":l.css("border-top-left-radius"),"background-color":l.css("background-color")}).insertAfter(l).click(function(){$(this).find("input").focus()});$('<li class="input-container">').addClass("flexdatalist-multiple-value").append(j).appendTo(m)}else{j.insertAfter(l)}if(j.attr("autofocus")){j.focus()}l._init=function(){var n=l._options();j.on("input keydown",function(o){var p=l._keyword();if((e._keyNum(o)===188||e._keyNum(o)===13)&&!n.selectionRequired&&n.multiple&&!l._resultSelected()){o.preventDefault();l._value(p);l._removeResults()}else{if(e._keyNum(o)===9){l._removeResults()}else{if(p.length===0&&n.multiple&&e._keyNum(o)===8){j.data("_remove",j.parents("li:eq(0)").prev())}}}}).on("input keyup",function(q){if(l._changed()&&e._keyNum(q)!==13){var o=l._keyword();if(!n.multiple){n._values=[];if(!n.selectionRequired){l._value(o)}else{l._value("")}}if(o.length>=n.minLength){l._search(function(r){l._showResults(r)})}else{l._removeResults()}}var p=j.data("_remove");if(p){p.find(".fdl-remove").click();j.data("_remove",null)}i=l._keyword()}).on("focus",function(){var o=l._keyword();if(n.minLength===0){if(o===""){l._tdata(function(p){l._showResults(p)})}}else{if(o.length>=n.minLength&&!l._selected()){l._search(function(p){l._showResults(p)})}}}).on("focusin",function(){l.parent().find(".flexdatalist-multiple").addClass("focus")}).on("focusout",function(){l.parent().find(".flexdatalist-multiple").removeClass("focus")}).on("blur",function(){if(!l._resultSelected()&&n.multiple&&!n.selectionRequired){l._value(l._keyword())}}).attr("autocomplete","off");window.onresize=function(o){l._position()};l.addClass("flexdatalist flexdatalist-set").prop("type","hidden")};l._resultSelected=function(){return $("ul.flexdatalist-results").find("li.item.active").length>0};l._changed=function(){return i!==l._keyword()};l._chained=function(){var o=l._options();if(!o.relatives||!o.chainedRelatives){return}var n=function(p){o.relatives.each(function(){var q=e._isEmpty($(this).val()),r=e._isEmpty(l.val());j.prop("disabled",q);if(!p&&(q||!r)){l._value("");j.val("");if(o.multiple){m.find("li .fdl-remove").click()}}if(m){q&&m?m.addClass("disabled"):m.removeClass("disabled")}})};o.relatives.on("change",function(){n();k={}});n(true)};l._initValue=function(){var n=l.attr("value");if(e._isEmpty(n)){return}l._options("originalValue",l.val());l._options("searchEqual",true);l._parseValue(n,function(o){l.val("",true);j.val("");l._options("searchEqual",false);if(!e._isEmpty(o)){l._values(o,true)}i=l._keyword()})};l._parseValue=function(q,s){var o=l._options();if(l._toJSON()){try{s(JSON.parse(q))}catch(r){}}else{if(l._toCSV()||typeof o.valueProperty==="string"){var p=q.split(",");if(typeof o.valueProperty==="string"){var n=o.searchIn;o.searchIn=o.valueProperty.split(",");o.searchEqual=true;l._search(function(t){if(t.length>0){s(t)}o.searchIn=n;o.searchEqual=false},p)}else{s(p)}}else{s(q)}}};l._tdata=function(n){l.trigger("before:flexdatalist.data");l._url(function(o){l._data(function(s){s=s.concat(o);var p=l._options("_values");for(var q=0;q<s.length;q++){var r=s[q];if(p&&p.indexOf(l._getText(r))>-1){delete s[q]}}l.trigger("after:flexdatalist.data",[s]);n(s)})})};l._data=function(o){var n=l._options();if(typeof n.data==="string"){l._remote({url:n.data,success:function(q){var p=l._getRemoteData(q);n.data=p;o(p)}})}else{o(n.data)}};l._url=function(r){var n=l._options(),o=l._keyword(),p=l.val(),q=o;if(e._isEmpty(n.url)){return r([])}clearTimeout(g);g=setTimeout(function(){if(n.cache&&n.cache!==2){q=o.substring(0,(n.minLength>0?n.minLength:1))}var t=l._cache(q);if(t&&n.cache){r(t);return}var s={};if(n.requestType=="post"){$.each(n,function(u,v){if(u.indexOf("_")==0){return}s[u]=v});delete s.relatives}l._remote({url:n.url,data:$.extend(l._relativesData(),n.params,{keyword:o,contain:n.searchContain,selected:p,options:s}),success:function(v){var u=l._getRemoteData(v),w=l._keyword();if(w.length>=o.length){r(u)}l._cache(q,u)}})},200)};l._remote=function(n){if(l.hasClass("flexdatalist-loading")){return}l.addClass("flexdatalist-loading");n=$.extend({type:l._options("requestType"),dataType:"json",complete:function(){l.removeClass("flexdatalist-loading")}},n);$.ajax(n)};l._getRemoteData=function(o){var n=o.results?o.results:o;if(typeof n==="string"&&n.indexOf("[{")===0){n=JSON.parse(n)}if(n.options){e._options(l,n.options)}if(e._isObject(n)){return n}return[]};l._relativesData=function(){var n=l._options("relatives"),o={};if(n){o.relatives={};n.each(function(){var p=$(this),q=p.attr("name").split("][").join("-").split("]").join("-").split("[").join("-").replace(/^\|+|\-+$/g,"");o.relatives[q]=p.val()})}return o};l._datalist=function(){var n=l._options(),o=l.attr("list");if(!e._isEmpty(o)){n.data=[];$("#"+o).find("option").each(function(){var q=$(this),r=q.val(),p=q.text();n.data.push({label:(p.length>0?p:r),value:r})})}return l};l._cache=function(n,o){if(l._options("cache")){n=l._normalizeString(n);if(!e._isDefined(o)){if(e._isDefined(k,n)){o=k[n]}return o}k[n]=o}return null};l._search=function(o,n){l._tdata(function(t){var s=[],p=l._options();if(p.searchDisabled){return o(t)}if(!e._isDefined(n)){n=l._keyword()}l.trigger("before:flexdatalist.search",[n,t]);n=l._split(n);for(var q=0;q<t.length;q++){var r=l._matches(t[q],n);if(r){s.push(r)}}l.trigger("after:flexdatalist.search",[n,t,s]);o(s)})};l._matches=function(z,q){var o=false,u=$.extend({},z),x=l._options(),A=[],t=x.searchIn;if(q.length>0){for(var s=0;s<t.length;s++){var y=t[s];if(!e._isDefined(z,y)||!z[y]){continue}var w=z[y].toString(),p=w,v=l._split(w);for(var n=0;n<q.length;n++){var r=q[n];if(l._find(r,v)){A.push(r);p=l._highlight(r,p)}}if(p!==w){u[y+"_highlight"]=l._highlight(p)}}}if(A.length===0||(x.searchByWord&&A.length<(q.length-1))){return false}return u};l._highlight=function(n,o){if(o){return o.replace(new RegExp(n,(l._options("searchContain")?"ig":"i")),"|:|$&|::|")}n=n.split("|:|").join('<span class="highlight">');return n.split("|::|").join("</span>")};l._find=function(p,o){var n=l._options();for(var q=0;q<o.length;q++){var r=o[q];r=l._normalizeString(r),p=l._normalizeString(p);if(n.searchEqual){return r==p}if((n.searchContain?(r.indexOf(p)>=0):(r.indexOf(p)===0))){return true}}return false};l._split=function(q){if(typeof q==="string"){q=[$.trim(q)]}var n=l._options();if(n.searchByWord){for(var p=0;p<q.length;p++){var o=$.trim(q[p]);if(o.indexOf(" ")>0){var r=o.split(" ");$.merge(q,r)}}}return q};l._showResults=function(p){l._removeResults(true);var n=l._options();if(p.length===0){l._noResults(n.noResultsText);return}var o=l._getResultsContainer();if(!n.groupBy){l._items(p,o)}else{p=l._groupData(p);Object.keys(p).forEach(function(w,s){var r=p[w],u=n.groupBy,t=l._getHighlight(r[0],u,w);var v=$("<li>").addClass("group").append($("<span>").addClass("group-name").html(t)).append($("<span>").addClass("group-item-count").text(" "+r.length)).appendTo(o);l._items(r,o)})}var q=o.find("li:not(.group)");q.on("click",function(s){var r=$(this).data("item");if(r){l._selected(true)._removeResults()._value(r);l.trigger("select:flexdatalist",[r,n])}}).hover(function(){q.removeClass("active");$(this).addClass("active")},function(){$(this).removeClass("active")});if(n.focusFirstResult){q.filter(":first").addClass("active")}};l._noResults=function(p){if(e._isEmpty(p)){return}var o=l._getResultsContainer(),n=l._keyword();p=p.split("{keyword}").join(n);$("<li>").addClass("item no-results").append(p).appendTo(o)};l._groupData=function(o){var r=[],s=l._options("groupBy");for(var p=0;p<o.length;p++){var q=o[p];if(e._isDefined(q,s)){var n=q[s];if(!e._isDefined(r,n)){r[n]=[]}r[n].push(q)}}return r};l._items=function(o,q){var n=l._options("maxShownResults");l.trigger("show:flexdatalist.results",[o]);for(var p=0;p<o.length;p++){if(n>0&&n===p){break}l._item(o[p]).appendTo(q)}l.trigger("shown:flexdatalist.results",[o])};l._item=function(r){var u=$("<li>").data("item",r).addClass("item"),n=l._options(),o=n.visibleProperties;for(var q=0;q<o.length;q++){var t=o[q];if(n.groupBy&&n.groupBy===t||!e._isDefined(r,t)){continue}var p={};if(t==="thumb"){p=$("<img>").addClass("item item-"+t).attr("src",r[t])}else{var s=l._getHighlight(r,t);p=$("<span>").addClass("item item-"+t).html(s+" ")}p.appendTo(u)}return u};l._getHighlight=function(n,o,p){if(e._isDefined(n,o+"_highlight")){return n[o+"_highlight"]}return(e._isDefined(n,o)?n[o]:p)};l._getResultsContainer=function(){var n=l;if(l._options("multiple")){n=m}var o=$("ul.flexdatalist-results");if(o.length===0){o=$("<ul>").addClass("flexdatalist-results").appendTo("body").css({"border-color":n.css("border-left-color"),"border-width":"1px","border-bottom-left-radius":n.css("border-bottom-left-radius"),"border-bottom-right-radius":n.css("border-bottom-right-radius")}).data("target",j);l._position()}return o};l._removeResults=function(o){var n="ul.flexdatalist-results";if(o){n="ul.flexdatalist-results li"}$(n).remove();return l};l._selected=function(o){var n="flexdatalist-selected";if(!e._isDefined(o)){return l.hasClass(n)}o?l.addClass(n):l.removeClass(n);return l};l._values=function(n,o){if($.isArray(n)&&!e._isEmpty(n)){$.each(n,function(p,q){l._value(q,o)});return}l._value(n,o)};l._value=function(s,r){var n=l._options(),q=l._getText(s),p=l._getValue(s);if(q.length>0&&!n.allowDuplicateValues){n._values.push(q)}if(n.multiple){if(s===""){return l}j.val("");var o=m.find("li.input-container"),t=$("<li>").addClass("value"+(n.toggleSelected?" toggle":"")).append('<span class="text">'+q+"</span>").append('<span class="fdl-remove">&times;</span>').insertBefore(o);o.find("input").focus();t.find("span.fdl-remove").click(function(){var w=$(this).parent(),u=w.index();if(!w.hasClass("disabled")&&(l._toJSON()||l._toCSV())){var v=l._normalizeValue();v.splice(u,1);n._values.splice(u,1);l._normalizeValue(v);l._allowValues()}w.remove()});if(n.toggleSelected){t.click(function(){var u=$(this),w=l._normalizeValue(),v=u.index();if(u.hasClass("disabled")){var x=u.data("_value");w.splice(v,0,x);n._values.splice(v,0,l._getText(x));u.removeClass("disabled")}else{var x=w.splice(v,1);u.data("_value",x[0]);n._values.splice(v,1);u.addClass("disabled")}l._normalizeValue(w,q)})}}else{if(q&&q!==j.val()){j.val(q)}}l._normalizeValue(p,q,r);i=l._keyword();return l};l._normalizeValue=function(p,s,r){var o=l._toJSON(),n=l._options(),q=l._toCSV();if(!e._isDefined(p)){p=l.val();if(p){if(o){p=JSON.parse(p)}else{if(q){p=p.split(",")}}}else{if(o||q){p=[]}}return p}l._allowValues();if(e._isObject(p)){if(o&&!e._isEmpty(p)){p=JSON.stringify(p)}else{if(q){p=p.join(",")}}}if(p==l.val()){return p}if(p===""){l._options("_values",[])}l.val(p,true);if(!r&&l._changed()){l.trigger("change:flexdatalist",[p,s,l._options()]).trigger("change")}return p};l._getText=function(o){var p=o,n=l._options();if(e._isObject(o)){p=o[n.searchIn[0]];if(e._isDefined(o,n.textProperty)){p=o[n.textProperty]}else{p=l._replacePlaceholders(o,n.textProperty,p)}}return $("<div>").html(p).text()};l._getValue=function(s){var t=s,n=l._options();if(e._isObject(s)){t=s[n.searchIn[0]];if(n.valueProperty==="*"){t=s}else{if(e._isDefined(s,n.valueProperty)){t=s[n.valueProperty]}else{if(l._toJSON()){var t={},p=n.valueProperty,r=n.textProperty;if(r){var o=r;if(typeof r==="string"){o=l._parsePlaceholders(r)}if(e._isObject(o)){$.each(o,function(u,v){p.push(v)})}}else{if(e._isDefined(s,r)){p.push(r)}}$.each(p,function(u,v){if(e._isDefined(s,v)){t[v]=s[v]}})}}}}if(n.multiple&&(l._toJSON()||l._toCSV())){var q=l._normalizeValue();if(!e._isEmpty(t)&&e._isObject(q)){q.push(t);t=q}}return t};l._replacePlaceholders=function(o,q,p){if(e._isObject(o)&&typeof q==="string"){var n=l._parsePlaceholders(q);if(!e._isEmpty(o)&&n){$.each(n,function(r,s){if(e._isDefined(o,s)){q=q.replace(r,o[s])}});return q}}return p};l._parsePlaceholders=function(p){var o=p.match(/\{.+?\}/g);if(o){var n={};o.map(function(q){n[q]=q.slice(1,-1)});return n}return false};l._allowValues=function(){var n=l._options();if(n.limitOfValues>0&&n.multiple){var o=m.find(".flexdatalist-multiple-value");(n._values.length>=n.limitOfValues?o.hide():o.show())}};l._normalizeString=function(n){if(typeof n==="string"){var o=l._options("normalizeString");if(typeof o==="function"){n=o(n)}return n.toUpperCase()}return n};l._keyword=function(){return j.val().replace(/^\s+/,"")};l._toJSON=function(){var n=l._options("valueProperty");return e._isObject(n)||n==="*"};l._toCSV=function(){return(!l._toJSON()&&l._options("multiple"))};l._position=function(){var n=j;if(l._options("multiple")){n=m}$("ul.flexdatalist-results").css({width:n.outerWidth()+"px",top:((n.offset().top+n.outerHeight()))+"px",left:n.offset().left+"px"})};l._init();l._datalist();l._chained();l._initValue()};this._destroy=function(g){if(!g){g=f}g.each(function(){var h=$(this).data("flexdatalist");$(this).removeClass("flexdatalist-set").attr("type","text").val((h&&h.originalValue?h.originalValue:"")).removeData("flexdatalist").next(".flexdatalist-alias, ul.flexdatalist-multiple").remove()})};this._reset=function(){this._destroy()};this._setValue=function(g){f.each(function(){var h=$(this);var i=h.data("flexdatalist");if(e._isDefined(i)){i.originalValue=g;if(g==""){h.val(g,true);if(i.multiple){h.next("ul.flexdatalist-multiple").find("li.value").remove()}return}e._destroy()}})};this._keyNum=function(g){return g.which||g.keyCode};if(!d.data("flexdatalist")){$(document).mouseup(function(h){var i=$(".flexdatalist-results"),g=i.data("target");if((!g||!g.is(":focus"))&&!i.is(h.target)&&i.has(h.target).length===0){i.remove()}}).keydown(function(l){var j=$(".flexdatalist-results"),n=j.find("li"),h=n.filter(".active"),i=h.index(),k=n.length,m=e._keyNum(l);if(k===0){return}if(e._keyNum(l)===27){return j.remove()}if(m===13){l.preventDefault();h.click()}else{if(m===40||m===38){l.preventDefault();if(m===40){if(i<k&&h.nextAll(".item").first().length>0){h=h.removeClass("active").nextAll(".item").first().addClass("active")}else{h=n.removeClass("active").filter(".item:first").addClass("active")}}else{if(m===38){if(i>0&&h.prevAll(".item").first().length>0){h=h.removeClass("active").prevAll(".item").first().addClass("active")}else{h=n.removeClass("active").filter(".item:last").addClass("active")}}}var g=(h.prev().length===0?h:h.prev()).position().top;j.animate({scrollTop:g+j.scrollTop()},100)}}}).data("flexdatalist",true)}this._isEmpty=function(g){if(!e._isDefined(g)){return true}else{if(g===null){return true}else{if(g===true){return false}else{if(this._length(g)===0){return true}else{if($.trim(g)===""){return true}}}}}return false};this._isObject=function(g){return(g&&typeof g==="object")};this._csvToArray=function(h,g){if(h.length===0){return g}return typeof h==="string"?h.split(","):h};this._length=function(g){if(this._isObject(g)){return Object.keys(g).length}else{if(typeof g.length==="number"){return g.length}}return 0};this._isDefined=function(g,i){var h=(typeof g!=="undefined");if(h&&typeof i!=="undefined"){return(typeof g[i]!=="undefined")}return h};this._options=function(g,j,h){var i=g.data("flexdatalist");if(e._isDefined(j)){if(e._isDefined(h)){i[j]=h}else{if(!e._isObject(j)){return(e._isDefined(i,j)?i[j]:null)}else{i=j}}i.searchIn=e._csvToArray(i.searchIn);i.relatives=i.relatives&&$(i.relatives).length>0?$(i.relatives):null;i.textProperty=i.textProperty===null?i.searchIn[0]:i.textProperty;i.visibleProperties=e._csvToArray(i.visibleProperties,i.searchIn);g.data("flexdatalist",i)}return i};if(typeof b==="string"){if(typeof this["_"+b]==="function"){if(!this["_"+b]()){return this}}else{if(b==="value"){this._setValue(c)}else{if(!c){return e._options(f,b)}else{e._options(f,b,c);return this}}}}return this.each(a)};var _defaultValFunc=jQuery.fn.val;jQuery.fn.val=function(a,b){if(!b&&$(this).hasClass("flexdatalist-set")&&typeof a!=="undefined"){$(this).flexdatalist("value",a)}return _defaultValFunc.apply(this,arguments)};$(function(){$("input.flexdatalist:not(.flexdatalist-set)").flexdatalist()});